<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Voor Kiki ‚ú®</title>

  <style>
    :root{
      --bg:#06060a; --fg:#fff;
      --muted:rgba(255,255,255,.78);
      --muted2:rgba(255,255,255,.55);
      --gold1:#ffe8c6; --gold2:#ff8a1f;
      --card:rgba(255,255,255,.07);
      --stroke:rgba(255,255,255,.12);
      --shadow: 0 22px 70px rgba(0,0,0,.60);
      --danger:#ff5a5a;
      --ok:#65ffb0;
    }

    html,body{
      height:100%;
      margin:0;
      background:var(--bg);
      color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      overflow:hidden; /* NO SCROLL */
    }
    *{box-sizing:border-box}

    /* Background */
    .bg{
      position:fixed; inset:0; pointer-events:none; overflow:hidden;
      background:
        radial-gradient(900px 520px at 20% 10%, rgba(255,138,31,.22), transparent 62%),
        radial-gradient(760px 520px at 80% 30%, rgba(255,226,178,.16), transparent 62%),
        radial-gradient(980px 780px at 50% 120%, rgba(255,138,31,.10), transparent 62%),
        linear-gradient(#050507, #090913);
      filter:saturate(1.05);
    }
    .stars{position:absolute; inset:-20%; opacity:.55; animation: drift 16s ease-in-out infinite alternate;
      background-image:
        radial-gradient(2px 2px at 10% 20%, rgba(255,255,255,.38) 40%, transparent 42%),
        radial-gradient(1px 1px at 30% 60%, rgba(255,255,255,.26) 40%, transparent 42%),
        radial-gradient(1.5px 1.5px at 70% 30%, rgba(255,255,255,.30) 40%, transparent 42%),
        radial-gradient(1px 1px at 85% 70%, rgba(255,255,255,.20) 40%, transparent 42%),
        radial-gradient(2px 2px at 55% 80%, rgba(255,255,255,.18) 40%, transparent 42%);
    }
    .glitter{position:absolute; inset:0; opacity:.22; animation: twinkle 3.8s ease-in-out infinite;
      background:
        radial-gradient(2px 2px at 15% 35%, rgba(255,226,178,.95) 30%, transparent 35%),
        radial-gradient(1px 1px at 65% 25%, rgba(255,138,31,.95) 30%, transparent 35%),
        radial-gradient(2px 2px at 78% 62%, rgba(255,226,178,.80) 30%, transparent 35%),
        radial-gradient(1px 1px at 40% 78%, rgba(255,138,31,.80) 30%, transparent 35%);
    }
    @keyframes drift{from{transform:translate3d(-1.5%,-1.0%,0) scale(1)}to{transform:translate3d(1.5%,1.0%,0) scale(1.02)}}
    @keyframes twinkle{0%,100%{opacity:.16}50%{opacity:.28}}

    /* Layout (NO scroll; everything fits) */
    .wrap{
      position:fixed; inset:0;
      display:grid; place-items:center;
      padding:16px;
      overflow:hidden;
    }

    .card{
      width:min(640px,100%);
      height: calc(100dvh - 32px);
      max-height: 820px;
      border-radius:28px;
      background:var(--card);
      border:1px solid var(--stroke);
      box-shadow:var(--shadow);
      padding:20px 18px;
      text-align:center;
      backdrop-filter: blur(12px);
      position:relative;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:12px;
      padding-bottom: calc(18px + env(safe-area-inset-bottom));
    }

    /* Fancy ornaments */
    .orn{position:absolute; pointer-events:none; opacity:.65; filter: drop-shadow(0 0 14px rgba(255,138,31,.22)); animation: floaty 6.5s ease-in-out infinite;}
    .orn.h{color:rgba(255,170,170,.85)}
    .orn.t{color:rgba(160,255,200,.75)}
    .orn.s{color:rgba(255,226,178,.85)}
    @keyframes floaty{0%,100%{transform:translateY(0) rotate(0deg); opacity:.55}50%{transform:translateY(-10px) rotate(4deg); opacity:.85}}

    .envelope{
      width:150px;height:106px;margin:0 auto;
      position:relative;border-radius:22px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 18px 55px rgba(0,0,0,.35);
      overflow:hidden;
      flex:0 0 auto;
    }
    .flap{
      position:absolute; left:-12%; right:-12%; top:-58%;
      height:125%;
      background:linear-gradient(135deg, rgba(255,226,178,.18), rgba(255,138,31,.10));
      transform-origin:50% 92%;
      transform:rotateX(0deg);
      border:1px solid rgba(255,255,255,.08);
      border-bottom:none;
      border-radius:24px;
    }
    .seal{
      position:absolute; left:50%; top:58%;
      transform:translate(-50%,-50%);
      width:44px;height:44px;border-radius:18px;
      background:radial-gradient(circle at 30% 30%, rgba(255,255,255,.25), transparent 35%),
                 linear-gradient(135deg,var(--gold1),var(--gold2));
      box-shadow:0 0 28px rgba(255,138,31,.40);
      display:grid; place-items:center;
      font-weight:900; letter-spacing:.5px;
      color:rgba(30,15,0,.85);
    }
    .opening .flap{ animation: openflap .70s ease forwards; }
    @keyframes openflap{ from{transform:rotateX(0deg)} to{transform:rotateX(72deg)} }

    .badge{
      display:inline-flex; gap:10px; align-items:center; justify-content:center;
      padding:9px 12px; border-radius:999px;
      background:rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.12);
      margin:0 auto;
      width:fit-content;
      flex:0 0 auto;
    }
    .spark{width:18px;height:18px; display:grid; place-items:center; filter: drop-shadow(0 0 10px rgba(255,138,31,.35));}

    h1{margin:0; font-size:28px; flex:0 0 auto;}
    p{margin:0; color:var(--muted); line-height:1.35; font-size:15px; flex:0 0 auto;}
    .bigline{margin:0; color:var(--muted2); font-size:14px; line-height:1.35; flex:0 0 auto;}

    .pill{
      display:inline-block; padding:2px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.85);
      font-weight:850;
      margin-left:6px;
    }

    /* Collapsible hints */
    details.hints{
      text-align:left;
      margin:0;
      padding:12px 12px;
      border-radius:18px;
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      flex:0 0 auto;
    }
    details.hints summary{
      cursor:pointer;
      font-weight:950;
      color:rgba(255,255,255,.90);
      list-style:none;
      outline:none;
    }
    details.hints summary::-webkit-details-marker{display:none;}
    .hintItem{margin:8px 0 0; color:rgba(255,255,255,.72); font-size:13px; line-height:1.35}

    .inputRow{display:flex; gap:10px; margin:0; flex:0 0 auto;}
    input{
      flex:1;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:#fff;
      padding:13px 14px;
      font-size:16px;
      outline:none;
      min-width:0;
    }
    input::placeholder{color:rgba(255,255,255,.45)}

    .btn{
      width:100%;
      padding:14px 16px;
      border:0;
      border-radius:18px;
      font-size:17px;
      font-weight:950;
      cursor:pointer;
      color:#140b00;
      background:linear-gradient(135deg,var(--gold1),var(--gold2));
      box-shadow:0 14px 42px rgba(255,138,31,.30);
      margin:0;
      flex:0 0 auto;
    }
    .btn.secondary{
      background:rgba(255,255,255,.08);
      color:rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:none;
    }
    .status{
      margin:0;
      font-size:13px;
      color:rgba(255,255,255,.70);
      min-height:18px;
      flex:0 0 auto;
    }
    .status.bad{color:rgba(255,90,90,.92)}
    .status.ok{color:rgba(101,255,176,.92)}

    /* TIMER GATE */
    .gate{
      position:fixed; inset:0; display:none; place-items:center; padding:16px;
      background:rgba(0,0,0,.78); backdrop-filter: blur(6px); z-index:60;
      overflow:hidden;
    }
    .gate.show{display:grid; animation:fade .35s ease both}
    @keyframes fade{from{opacity:0}to{opacity:1}}

    .gatebox{
      width:min(600px,92%);
      height: calc(100dvh - 32px);
      max-height: 820px;
      border-radius:28px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:var(--shadow);
      padding:20px 18px;
      text-align:center;
      position:relative;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:10px;
      padding-bottom: calc(18px + env(safe-area-inset-bottom));
    }
    .gatebox::before{
      content:"";
      position:absolute; inset:-2px;
      border-radius:30px;
      padding:2px;
      background:linear-gradient(135deg, rgba(255,232,198,.55), rgba(255,138,31,.35), rgba(255,232,198,.45));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity:.55;
      pointer-events:none;
    }

    /* Snowflakes */
    .gateSnow{position:absolute; inset:0; pointer-events:none; opacity:.55; z-index:1;}
    .flake{
      position:absolute; top:-30px;
      color:rgba(255,255,255,.90);
      font-size:16px;
      filter: drop-shadow(0 0 10px rgba(255,255,255,.10));
      animation: fall linear infinite;
      will-change: transform;
    }
    @keyframes fall{to{ transform: translateY(calc(100vh + 120px)) rotate(360deg); }}

    .gateTitle{font-weight:950; margin:0; position:relative; z-index:2}
    .gateSub{margin:0; color:rgba(255,255,255,.74); line-height:1.35; position:relative; z-index:2}
    .count{
      font-variant-numeric: tabular-nums;
      font-size:44px; font-weight:950; letter-spacing:1px;
      margin:0; position:relative; z-index:2;
      text-shadow:0 0 32px rgba(255,138,31,.20);
    }
    .openAt{margin:0; font-size:13px; color:rgba(255,255,255,.64); position:relative; z-index:2}
    .microhint{margin:0; font-size:13px; color:rgba(255,255,255,.76); line-height:1.35; position:relative; z-index:2}
    .row{display:flex; gap:10px; position:relative; z-index:2}
    .mini{
      flex:1; padding:12px 12px; border-radius:16px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.08); color:rgba(255,255,255,.92);
      font-weight:950; cursor:pointer;
    }
    .mini.primary{border:0; background:linear-gradient(135deg,var(--gold1),var(--gold2)); color:#140b00;}
    .mini[disabled]{opacity:.45; cursor:not-allowed}

    /* PLAYER */
    .player{position:fixed; inset:0; display:none; background:#000; z-index:40; overflow:hidden;}
    .player.show{display:block; animation:fade .45s ease both}
    .player iframe{position:absolute; inset:0; width:100%; height:100%; border:0; background:#000}

    .top{
      position:absolute; left:0; right:0;
      top: calc(0px + env(safe-area-inset-top));
      padding:12px;
      display:flex; gap:10px; justify-content:space-between; align-items:center;
      background:linear-gradient(to bottom, rgba(0,0,0,.72), transparent);
      z-index:45;
      flex-wrap:wrap;
    }
    .chip{
      font-size:12px; padding:9px 11px; border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.35); color:rgba(255,255,255,.86);
      backdrop-filter: blur(8px);
      white-space:nowrap;
    }
    button.chip{cursor:pointer}

    .banner{
      position:absolute;
      left:14px; right:14px;
      bottom: calc(14px + env(safe-area-inset-bottom));
      display:none;
      border-radius:20px; border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.45); backdrop-filter: blur(10px);
      padding:14px; z-index:60; text-align:left; box-shadow:0 18px 55px rgba(0,0,0,.45);
    }
    .banner.show{display:block; animation:fade .35s ease both}
    .banner h2{margin:0 0 6px; font-size:16px}
    .banner p{margin:0 0 10px; color:rgba(255,255,255,.74); font-size:13px; line-height:1.35}

    /* POST pages (after Part 2) */
    .post{
      position:fixed; inset:0;
      display:none; place-items:center;
      padding:16px;
      background:rgba(0,0,0,.80);
      backdrop-filter: blur(8px);
      z-index:80; /* ABOVE everything */
      overflow:hidden;
    }
    .post.show{display:grid; animation:fade .35s ease both}
    .postbox{
      width:min(600px,92%);
      height: calc(100dvh - 32px);
      max-height: 820px;
      border-radius:28px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:var(--shadow);
      padding:22px 18px;
      text-align:center;
      position:relative;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:12px;
      padding-bottom: calc(18px + env(safe-area-inset-bottom));
    }
    .postbox::before{
      content:"";
      position:absolute; inset:-2px;
      border-radius:30px;
      padding:2px;
      background:linear-gradient(135deg, rgba(255,232,198,.60), rgba(255,138,31,.35), rgba(255,232,198,.45));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity:.55;
      pointer-events:none;
    }
    .postTitle{font-weight:950; font-size:26px; margin:0; position:relative; z-index:2}
    .postText{margin:0; color:rgba(255,255,255,.78); font-size:15px; line-height:1.45; position:relative; z-index:2}
    .sig{margin-top:6px; font-weight:950; letter-spacing:.2px; position:relative; z-index:2}
    .confetti{
      position:absolute; inset:0; pointer-events:none; opacity:.45; z-index:1;
      background:
        radial-gradient(2px 2px at 12% 18%, rgba(255,226,178,.95) 45%, transparent 50%),
        radial-gradient(2px 2px at 72% 30%, rgba(255,138,31,.90) 45%, transparent 50%),
        radial-gradient(2px 2px at 46% 72%, rgba(255,170,170,.90) 45%, transparent 50%),
        radial-gradient(2px 2px at 82% 66%, rgba(160,255,200,.85) 45%, transparent 50%),
        radial-gradient(2px 2px at 26% 60%, rgba(255,226,178,.85) 45%, transparent 50%);
      animation: twinkle 3.2s ease-in-out infinite;
    }

    @media (max-height: 740px){
      h1{font-size:26px}
      .envelope{width:135px;height:96px}
      .count{font-size:40px}
      input{padding:12px 14px}
      .btn{padding:13px 16px; font-size:16px}
      .chip{padding:8px 10px}
      .postTitle{font-size:24px}
    }
    @media (max-width: 420px){
      .row{flex-direction:column}
      .mini{width:100%}
    }
  </style>
</head>

<body>
  <div class="bg">
    <div class="stars"></div>
    <div class="glitter"></div>
  </div>

  <!-- START / GAME -->
  <div class="wrap" id="start">
    <div class="card" id="card">
      <div class="orn s" style="left:10%; top:10%; animation-duration:7.2s;">‚ú¶</div>
      <div class="orn h" style="left:84%; top:12%; animation-duration:6.3s;">‚ô•</div>
      <div class="orn t" style="left:88%; top:58%; animation-duration:8.0s;">üéÑ</div>
      <div class="orn s" style="left:12%; top:70%; animation-duration:6.8s;">‚úß</div>

      <div class="envelope" id="env">
        <div class="flap"></div>
        <div class="seal"><span>K</span></div>
      </div>

      <div class="badge">
        <div class="spark">‚ú¶</div>
        <div>Voor Kiki</div>
        <div class="spark">üéÑ</div>
      </div>

      <h1>Mini uitdaging ‚ú®</h1>
      <p>Je hebt ‚Äôm op TikTok voorbij zien komen. üòâ</p>
      <div class="bigline">Raad het woord en unlock je verrassing.</div>

      <details class="hints">
        <summary>Hints (tap om te openen)</summary>
        <div class="hintItem">1) Het is √©√©n woord dat je zegt als iets ineens <span class="pill">overal</span> is</div>
        <div class="hintItem">2) Past bij <span class="pill">TikTok</span> en ‚Äúiedereen doet het‚Äù</div>
        <div class="hintItem">3) Het begint met een <span class="pill">V</span></div>
      </details>

      <div class="inputRow">
        <input id="answer" type="text" inputmode="text" autocomplete="off" autocapitalize="none"
               placeholder="Vul het woord in‚Ä¶" />
      </div>

      <button class="btn" id="unlock">Unlock üéÅ</button>
      <button class="btn secondary" id="hintBtn">Extra hint</button>

      <div class="status" id="status"></div>
    </div>
  </div>

  <!-- TIMER PAGE -->
  <div class="gate" id="gate">
    <div class="gatebox">
      <div class="gateSnow" id="gateSnow" aria-hidden="true"></div>

      <div class="orn s" style="left:8%; top:10%; animation-duration:7.2s;">‚ú¶</div>
      <div class="orn h" style="left:86%; top:12%; animation-duration:6.3s;">‚ô•</div>
      <div class="orn t" style="left:88%; top:52%; animation-duration:8.0s;">üéÑ</div>

      <div class="gateTitle">‚ú® Unlock gelukt</div>
      <div class="gateSub">Maar‚Ä¶ het cadeau opent pas als de timer op nul staat.</div>

      <div class="count" id="countdown">00:00:00</div>
      <div class="openAt" id="openAtText"></div>
      <div class="microhint" id="microHint"></div>

      <div class="row">
        <button class="mini" id="resetGate" type="button">Opnieuw</button>
        <button class="mini primary" id="openNow" type="button" disabled>Open cadeau üéÅ</button>
      </div>
    </div>
  </div>

  <!-- PLAYER -->
  <div class="player" id="player">
    <div class="top">
      <div class="chip">Voor Kiki ‚ú®</div>

      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
        <button class="chip" id="startBtn" type="button">Start ‚ñ∂</button>
        <button class="chip" id="soundBtn" type="button">Geluid üîä</button>
        <button class="chip" id="fsBtn" type="button">Fullscreen</button>
        <div class="chip" id="which">Deel 1</div>
      </div>
    </div>

    <iframe id="frame" src="" allow="autoplay; fullscreen" allowfullscreen></iframe>

    <div class="banner" id="banner">
      <h2>Ok√©‚Ä¶ klaar? üéÅ</h2>
      <p>Druk op deel 2 (d√°√°r zit de verrassing üòâ)</p>
      <div class="row">
        <button class="mini" id="replay1" type="button">Nog eens ‚ú®</button>
        <button class="mini primary" id="play2" type="button">Open deel 2 üíõ</button>
      </div>
    </div>
  </div>

  <!-- POST PAGE 1 (after Part 2) -->
  <div class="post" id="post1">
    <div class="postbox">
      <div class="confetti"></div>
      <div class="orn h" style="left:10%; top:14%; animation-duration:6.2s;">‚ô•</div>
      <div class="orn s" style="left:86%; top:16%; animation-duration:7.0s;">‚ú¶</div>
      <div class="orn t" style="left:88%; top:60%; animation-duration:8.0s;">üéÑ</div>

      <div class="postTitle">Je hebt ‚Äôm geopend üéÅ</div>
      <p class="postText">
        Ok√©‚Ä¶ eerlijk?<br>
        Ik hoop dat je even moest lachen. üíõ
      </p>
      <div class="row">
        <button class="mini" id="postReplay2" type="button">Nog eens ‚ú®</button>
        <button class="mini primary" id="postNext" type="button">Verder ‚ú®</button>
      </div>
    </div>
  </div>

  <!-- POST PAGE 2 (final) -->
  <div class="post" id="post2">
    <div class="postbox">
      <div class="confetti"></div>
      <div class="orn s" style="left:10%; top:14%; animation-duration:6.6s;">‚úß</div>
      <div class="orn h" style="left:86%; top:16%; animation-duration:7.4s;">‚ô•</div>
      <div class="orn t" style="left:84%; top:66%; animation-duration:8.2s;">üéÑ</div>

      <div class="postTitle">Dankjewel, Kiki üíõ</div>
      <p class="postText">
        Dankjewel dat je er bent.<br>
        En dat jij‚Ä¶ gewoon jij bent.
      </p>
      <div class="sig">‚Äî Kevin</div>
      <div class="row">
        <button class="mini" id="postAgain" type="button">Nog een keer</button>
        <button class="mini primary" id="postClose" type="button">Ok√© ‚ú®</button>
      </div>
    </div>
  </div>

  <script>
    // STREAMABLE IDs
    const VIDEO1_ID = "kf86g0";
    const VIDEO2_ID = "hdnue1";

    // Durations (marge) - pas aan als nodig
    const PART1_LENGTH = 8.0;
    const PART2_LENGTH = 15.5;

    // OPEN TIME (NL tijd) -> 31-12-2025 18:00
    const FIXED_OPEN_AT_ISO = "2025-12-31T18:00:00+01:00";

    // TEST:
    // ?test=1&openin=30  -> opent in 30 sec (per device)
    // ?test=1&reset=1    -> reset testtimer
    const TEST_DEFAULT_SECONDS = 45;

    // Antwoord (niet te heavy)
    const ACCEPTED_ANSWERS = ["viral", "viraal"];

    const EXTRA_HINTS = [
      "Het is √©√©n woord. Niet ingewikkeld.",
      "Denk: ‚Äòdit ging ineens he-le-maal rond‚Äô.",
      "Begint met V‚Ä¶ üòâ"
    ];
    let hintIndex = 0;

    const TIMER_HINTS = [
      "Kleine hint: je hebt ‚Äôt op TikTok voorbij zien komen‚Ä¶ en het heeft met onze gezamenlijke hobby te maken. üòâ",
      "Nog een mini-hint: er zijn 2 delen‚Ä¶ deel 2 is de echte üéÅ"
    ];

    const start = document.getElementById('start');
    const env = document.getElementById('env');

    const gate = document.getElementById('gate');
    const countdownEl = document.getElementById('countdown');
    const openAtText = document.getElementById('openAtText');
    const openNowBtn = document.getElementById('openNow');
    const resetGateBtn = document.getElementById('resetGate');
    const microHintEl = document.getElementById('microHint');
    const gateSnow = document.getElementById("gateSnow");

    const player = document.getElementById('player');
    const frame = document.getElementById('frame');
    const banner = document.getElementById('banner');
    const which = document.getElementById('which');

    const post1 = document.getElementById('post1');
    const post2 = document.getElementById('post2');

    const startBtn = document.getElementById('startBtn');
    const soundBtn = document.getElementById('soundBtn');

    const answer = document.getElementById('answer');
    const status = document.getElementById('status');

    let timers = [];
    let countdownTimer = null;
    let currentPart = 1;

    function clearTimers(){ timers.forEach(t => clearTimeout(t)); timers = []; }
    function clearCountdown(){ if (countdownTimer) clearInterval(countdownTimer); countdownTimer = null; }

    function hideAllOverlays(){
      gate.classList.remove('show');
      player.classList.remove('show');
      post1.classList.remove('show');
      post2.classList.remove('show');
      banner.classList.remove('show');
    }

    function qs(name){
      const u = new URL(location.href);
      return u.searchParams.get(name);
    }
    function isTestMode(){ return qs("test") === "1"; }

    function getOpenAtMs(){
      if (isTestMode() && qs("reset") === "1"){
        localStorage.removeItem("kiki_test_openat_v1");
      }
      if (isTestMode()){
        let t = Number(localStorage.getItem("kiki_test_openat_v1") || "0");
        if (!t){
          const sec = Number(qs("openin") || TEST_DEFAULT_SECONDS);
          t = Date.now() + (Math.max(5, sec) * 1000);
          localStorage.setItem("kiki_test_openat_v1", String(t));
        }
        return t;
      }
      return new Date(FIXED_OPEN_AT_ISO).getTime();
    }

    function norm(s){
      return (s || "").trim().toLowerCase().replace(/\s+/g, "");
    }

    function requestFs(){
      const el = document.getElementById('player');
      const rfs = el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen;
      if (rfs) { try { rfs.call(el); } catch(e) {} }
    }

    function pad2(n){ return String(n).padStart(2, "0"); }
    function formatRemaining(ms){
      const total = Math.max(0, Math.floor(ms / 1000));
      const h = Math.floor(total / 3600);
      const m = Math.floor((total % 3600) / 60);
      const s = total % 60;
      return `${pad2(h)}:${pad2(m)}:${pad2(s)}`;
    }
    function formatOpenAt(openAtMs){
      const d = new Date(openAtMs);
      const fmt = new Intl.DateTimeFormat('nl-NL', {
        weekday:"long", year:"numeric", month:"long", day:"numeric",
        hour:"2-digit", minute:"2-digit"
      });
      return fmt.format(d);
    }

    // Streamable embed builder
    function streamableUrl(id, { muted=true } = {}){
      const base = `https://streamable.com/e/${id}`;
      const params = new URLSearchParams();
      params.set("autoplay","1");
      params.set("hd","1");
      params.set("nocontrols","1");
      if (muted) params.set("muted","1");
      params.set("_", String(Date.now())); // cache-buster
      return `${base}?${params.toString()}`;
    }

    function showPlayer(){
      hideAllOverlays();
      start.style.display = 'none';
      player.classList.add('show');
    }

    function setVideo(part, { muted=true } = {}){
      currentPart = part;
      which.textContent = part === 1 ? "Deel 1" : "Deel 2";
      const id = part === 1 ? VIDEO1_ID : VIDEO2_ID;
      frame.src = streamableUrl(id, { muted });
    }

    function showPost1(){
      // stop player (iframe layer issues weg) en toon vervolg
      player.classList.remove('show');
      post1.classList.add('show');
    }
    function showPost2(){
      post1.classList.remove('show');
      post2.classList.add('show');
    }

    function playPart1(){
      clearTimers();
      showPlayer();
      setVideo(1, { muted:true });
      timers.push(setTimeout(() => banner.classList.add('show'), PART1_LENGTH * 1000));
    }

    function playPart2(){
      clearTimers();
      banner.classList.remove('show');
      showPlayer();
      setVideo(2, { muted:true });

      // Na deel 2 -> vervolg pagina 1 (werkt betrouwbaarder dan overlay op iframe)
      timers.push(setTimeout(showPost1, PART2_LENGTH * 1000));
    }

    function renderGateSnow(){
      if (!gateSnow) return;
      gateSnow.innerHTML = "";
      const count = 26;
      for (let i=0;i<count;i++){
        const s = document.createElement("div");
        s.className = "flake";
        s.textContent = "‚ùÑ";
        const left = Math.random() * 100;
        const size = 12 + Math.random() * 16;
        const dur = 6 + Math.random() * 8;
        const delay = -Math.random() * dur;
        s.style.left = left + "%";
        s.style.fontSize = size + "px";
        s.style.animationDuration = dur + "s";
        s.style.animationDelay = delay + "s";
        gateSnow.appendChild(s);
      }
    }

    function showGate(openAtMs){
      hideAllOverlays();
      start.style.display = 'none';
      gate.classList.add('show');

      renderGateSnow();
      openAtText.textContent = `Opent op: ${formatOpenAt(openAtMs)}${isTestMode() ? " (TEST)" : ""}`;

      if (microHintEl){
        microHintEl.textContent = "";
        setTimeout(() => { microHintEl.textContent = TIMER_HINTS[0]; }, 4500);
        setTimeout(() => { microHintEl.textContent = TIMER_HINTS[1]; }, 12000);
      }

      function tick(){
        const remaining = openAtMs - Date.now();
        countdownEl.textContent = formatRemaining(remaining);
        if (remaining <= 0){
          openNowBtn.disabled = false;
          openAtText.textContent = "Het cadeau is nu open. üòâ";
          if (microHintEl) microHintEl.textContent = "Ok√©‚Ä¶ nu mag je ‚Äòm openmaken. ‚ú®";
        } else {
          openNowBtn.disabled = true;
        }
      }

      clearCountdown();
      tick();
      countdownTimer = setInterval(tick, 250);
    }

    function unlock(){
      const a = norm(answer.value);
      if (!a){
        status.className = "status bad";
        status.textContent = "Vul eerst een woord in üôÇ";
        return;
      }
      if (!ACCEPTED_ANSWERS.includes(a)){
        status.className = "status bad";
        status.textContent = "Hmm‚Ä¶ bijna. Probeer nog eens.";
        return;
      }

      status.className = "status ok";
      status.textContent = "Yes! Unlock gelukt ‚ú®";
      env.classList.add('opening');

      localStorage.setItem("kiki_unlocked_v2", "1");
      localStorage.setItem("kiki_unlocked_v1", "1");

      showGate(getOpenAtMs());
    }

    document.getElementById('unlock').addEventListener('click', unlock);
    answer.addEventListener('keydown', (e) => { if (e.key === "Enter") unlock(); });

    document.getElementById('hintBtn').addEventListener('click', () => {
      status.className = "status";
      status.textContent = EXTRA_HINTS[hintIndex % EXTRA_HINTS.length];
      hintIndex++;
    });

    openNowBtn.addEventListener('click', () => {
      if (openNowBtn.disabled) return;
      playPart1();
    });

    resetGateBtn.addEventListener('click', () => {
      localStorage.removeItem("kiki_unlocked_v2");
      localStorage.removeItem("kiki_unlocked_v1");
      clearCountdown();
      location.reload();
    });

    document.getElementById('replay1').addEventListener('click', playPart1);
    document.getElementById('play2').addEventListener('click', playPart2);
    document.getElementById('fsBtn').addEventListener('click', requestFs);

    // Android autoplay fix:
    startBtn.addEventListener('click', () => {
      const part = currentPart || 1;
      setVideo(part, { muted:true });
    });
    soundBtn.addEventListener('click', () => {
      const part = currentPart || 1;
      setVideo(part, { muted:false });
    });

    // Post pages buttons
    document.getElementById('postReplay2').addEventListener('click', () => {
      post1.classList.remove('show');
      playPart2();
    });
    document.getElementById('postNext').addEventListener('click', showPost2);
    document.getElementById('postAgain').addEventListener('click', () => location.reload());
    document.getElementById('postClose').addEventListener('click', () => {
      // sluit alles en ga terug naar start (of laat zwart)
      post2.classList.remove('show');
      location.reload();
    });

    // Boot: als ze al unlocked is -> direct timer
    (function boot(){
      if (localStorage.getItem("kiki_unlocked_v2") === "1" || localStorage.getItem("kiki_unlocked_v1") === "1"){
        showGate(getOpenAtMs());
      }
    })();
  </script>
</body>
</html>
